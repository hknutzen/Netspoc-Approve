#!/bin/sh
# Delete policy-directories older than one year.
# This should be started by a daily cronjob.

# Abort on error.
set -e

abort () { echo $@ >&2; exit 1; }

# Get netspoc directory from config file
DIR=$(get-netspoc-approve-conf netspocdir)

# Get netspoc directory from config file
DAYS=$(get-netspoc-approve-conf keep_history)

# Ensure a sane value for DAYS, take 365 as default
if [ -z "$DAYS" ]; then
    DAYS=365
else
    case $DAYS in
        ''|*[!0-9]*)
            abort "Expected numeric value for parameter \"keep_history\", but got:'$DAYS'.";
            exit 13;;
        *)
            if [ $DAYS -lt 30 ]; then
                abort "Parameter \"keep_history\" has to be >= 30."
                exit 14
            fi;;
    esac
fi

# Find toplevel directories, modified more than 365 days ago.
find $DIR -maxdepth 1 -mtime +$DAYS -exec rm -rf {} \;
