#!/bin/sh
# Read lines from standard input.
# Starts each line as command in background.
# Command line parameter controls maximum number of running commands.

usage() { 
    echo "Usage: $0 [-q] <max proc>"; 
    echo " Reads commands line by line from stdin"
    echo " and starts them concurrently."
    echo " -q: run quiet, don't echo executed command line"
    echo " <max proc>: a number greater or equal 1"
    echo "             controls how many processes are started concurrently"
    exit 1; 
}

verbose='-t'
case $1 in
    -q)	verbose=''; shift ;;
esac
max=$1

let max=$max+0
[ $max -gt 0 ] || usage

xargs -d '\n' -n1 -r $verbose -P $max sh -c &&
[ "$verbose" ] && echo '*Finished*' >/dev/stderr
